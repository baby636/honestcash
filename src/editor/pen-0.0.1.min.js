!function(a){if(a.Pen){var b={keymap:{96:"`",62:">",49:"1",46:".",45:"-",42:"*",35:"#"},stack:[]};b.valid=function(a){var b=a.length;return a.match(/[#]{1,6}/)?["h"+b,b]:"```"===a?["pre",b]:">"===a?["blockquote",b]:"1."===a?["insertorderedlist",b]:"-"===a||"*"===a?["insertunorderedlist",b]:a.match(/(?:\.|\*|\-){3,}/)?["inserthorizontalrule",b]:void 0},b.parse=function(a){var b=a.keyCode||a.which;if(32===b){var c=this.stack.join("");this.stack=[];var d=this.valid(c);if(d)return a.preventDefault(),d}return this.keymap[b]&&this.stack.push(this.keymap[b]),!1},b.action=function(a,b){if(!(a.selection.focusOffset>b[1])){var c=a.selection.focusNode;c.textContent=c.textContent.slice(b[1]),a.execCommand(b[0])}},b.init=function(a){a.on("keypress",function(c){var d=b.parse(c);return d?b.action(a,d):void 0})},a.Pen.prototype.markdown=b}}(window),function(a,b){function c(a,c,d){var e=" to exec 「"+c+"」 command"+(d?" with value: "+d:"");try{b.execCommand(c,!1,d)}catch(f){return A.log("fail"+e,!0)}A.log("success"+e)}function d(a,b,d){var e=q(a);if(e)return a._range.selectNode(e),a._range.collapse(!1),"insertimage"===b&&a._menu&&w(a._menu,!0),c(a,b,d)}function e(a,b){var d=r(a,q(a),!0);return-1!==d.indexOf(b)&&(b="p"),c(a,"formatblock",b)}function f(a,b,d){return d="<"+b+">"+(d||z.toString())+"</"+b+">",c(a,"insertHTML",d)}function g(a,b,d){return a.config.linksInNewWindow?(d='< a href="'+d+'" target="_blank">'+z.toString()+"</a>",c(a,"insertHTML",d)):c(a,b,d)}function h(a){var c="",d='<input class="pen-input" placeholder="http://" />';if(a._toolbar=a.config.toolbar,a._toolbar)(a._toolbar.querySelectorAll("[data-action=createlink]").length||a._toolbar.querySelectorAll("[data-action=insertimage]").length)&&(c+=d);else{var e=a.config.list;A.forEach(e,function(b){var d="pen-icon icon-"+b,e=a.config.titles[b]||"";c+='<i class="'+d+'" data-action="'+b+'" title="'+e+'"></i>'},!0),(e.indexOf("createlink")>=0||e.indexOf("insertimage")>=0)&&(c+=d)}c&&(a._menu=b.createElement("div"),a._menu.setAttribute("class",a.config["class"]+"-menu pen-menu"),a._menu.innerHTML=c,a._inputBar=a._menu.querySelector("input"),w(a._menu,!0),b.body.appendChild(a._menu)),a._toolbar&&a._inputBar&&w(a._inputBar)}function i(c){function d(a){c._range=c.getRange(),g(a)}var e=c._toolbar||c._menu,f=c.config.editor,g=A.delayExec(function(){c.highlight().menu()}),h=function(){};if(c._menu){var i=function(){"block"===c._menu.style.display&&c.menu()};j(c,a,"resize",i),j(c,a,"scroll",i);var k=!1;j(c,f,"mousedown",function(){k=!0}),j(c,f,"mouseleave",function(){k&&d(800),k=!1}),j(c,f,"mouseup",function(){k&&d(100),k=!1}),h=function(a){!c._menu||p(f,a.target)||p(c._menu,a.target)||(l(c,b,"click",h),g(100))}}else j(c,f,"click",function(){d(0)});j(c,f,"keyup",function(a){if(8===a.which&&c.isEmpty())return s(c,!0);if(13!==a.which||a.shiftKey)return d(400);var e=q(c,!0);e&&e.nextSibling&&E.test(e.nodeName)&&e.nodeName===e.nextSibling.nodeName&&("BR"!==e.lastChild.nodeName&&e.appendChild(b.createElement("br")),A.forEach(e.nextSibling.childNodes,function(a){a&&e.appendChild(a)},!0),e.parentNode.removeChild(e.nextSibling),t(c,e.lastChild,c.getRange()))}),j(c,f,"keydown",function(a){if(f.classList.remove("pen-placeholder"),13===a.which&&!a.shiftKey){var d=q(c,!0);if(d&&E.test(d.nodeName)){var e=d.lastChild;if(e&&e.previousSibling&&!e.previousSibling.textContent&&!e.textContent){a.preventDefault();var g=b.createElement("p");g.innerHTML="<br>",d.removeChild(e),d.nextSibling?d.parentNode.insertBefore(g,d.nextSibling):d.parentNode.appendChild(g),t(c,g,c.getRange())}}}});var m=function(a,b){c.execCommand(a,b),c._range=c.getRange(),c.highlight().menu()};j(c,e,"click",function(a){for(var b,d=a.target;d!==e&&!(b=d.getAttribute("data-action"));)d=d.parentNode;if(b){if(!/(?:createlink)|(?:insertimage)/.test(b))return m(b);if(c._inputBar){var f=c._inputBar;if(e===c._menu?w(f):(c._inputActive=!0,c.menu()),"none"!==c._menu.style.display){setTimeout(function(){f.focus()},400);var g=function(){var a=f.value;a?a=f.value.replace(G.whiteSpace,"").replace(G.mailTo,"mailto:$1").replace(G.http,"http://$1"):b="unlink",m(b,a),e===c._menu?w(f,!1):w(c._menu,!0)};f.onkeypress=function(a){return 13===a.which?g():void 0}}}}}),j(c,f,"focus",function(){c.isEmpty()&&s(c,!0),j(c,b,"click",h)}),j(c,f,"blur",function(){n(c),c.checkContentChange()}),j(c,f,"paste",function(){setTimeout(function(){c.cleanContent()})})}function j(a,b,c,d){if(a._events.hasOwnProperty(c))a._events[c].push(d);else{a._eventTargets=a._eventTargets||[],a._eventsCache=a._eventsCache||[];var e=a._eventTargets.indexOf(b);0>e&&(e=a._eventTargets.push(b)-1),a._eventsCache[e]=a._eventsCache[e]||{},a._eventsCache[e][c]=a._eventsCache[e][c]||[],a._eventsCache[e][c].push(d),b.addEventListener(c,d,!1)}return a}function k(a,b){if(a._events.hasOwnProperty(b)){var c=C.call(arguments,2);A.forEach(a._events[b],function(b){b.apply(a,c)})}}function l(a,b,c,d){var e=a._events[c];if(!e){var f=a._eventTargets.indexOf(b);f>=0&&(e=a._eventsCache[f][c])}if(!e)return a;var g=e.indexOf(d);return g>=0&&e.splice(g,1),b.removeEventListener(c,d,!1),a}function m(a){return A.forEach(this._events,function(a){a.length=0},!1),a._eventsCache?(A.forEach(a._eventsCache,function(b,c){var d=a._eventTargets[c];A.forEach(b,function(a,b){A.forEach(a,function(a){d.removeEventListener(b,a,!1)},!0)},!1)},!0),a._eventTargets=[],a._eventsCache=[],a):a}function n(a){a.config.editor.classList[a.isEmpty()?"add":"remove"]("pen-placeholder")}function o(a){return(a||"").replace(/^\s+|\s+$/g,"")}function p(a,b){if(a===b)return!0;for(b=b.parentNode;b;){if(b===a)return!0;b=b.parentNode}return!1}function q(a,b){var c,d=a.config.editor;if(a._range=a._range||a.getRange(),c=a._range.commonAncestorContainer,!c||c===d)return null;for(;c&&1!==c.nodeType&&c.parentNode!==d;)c=c.parentNode;for(;c&&b&&c.parentNode!==d;)c=c.parentNode;return p(d,c)?c:null}function r(a,b,c){var d=[];for(b=b||a.config.editor;b&&b!==a.config.editor;)b.nodeName.match(F)&&d.push(c?b.nodeName.toLowerCase():b),b=b.parentNode;return d}function s(a,c){var d=a._range=a.getRange(),e=b.createElement("p");c&&(a.config.editor.innerHTML=""),e.innerHTML="<br>",d.insertNode(e),t(a,e.childNodes[0],d)}function t(a,b,c){c.setStartAfter(b),c.setEndBefore(b),c.collapse(!1),a.setRange(c)}function u(a){if(1===a.nodeType){if(H.notLink.test(a.tagName))return;A.forEach(a.childNodes,function(a){u(a)},!0)}else if(3===a.nodeType){var c=v(a.nodeValue||"");if(!c.links)return;var d=b.createDocumentFragment(),e=b.createElement("div");for(e.innerHTML=c.text;e.childNodes.length;)d.appendChild(e.childNodes[0]);a.parentNode.replaceChild(d,a)}}function v(a){var b=0;return a=a.replace(H.url,function(a){var c=a,d=a;return b++,a.length>H.maxLength&&(d=a.slice(0,H.maxLength)+"..."),H.prefix.test(c)||(c="http://"+c),'<a href="'+c+'">'+d+"</a>"}),{links:b,text:a}}function w(a,b){a.style.display=b?"none":"block"}var x,y,z,A={},B=Object.prototype.toString,C=Array.prototype.slice,D={block:/^(?:p|h[1-6]|blockquote|pre)$/,inline:/^(?:bold|italic|underline|insertorderedlist|insertunorderedlist|indent|outdent)$/,source:/^(?:createlink|unlink)$/,insert:/^(?:inserthorizontalrule|insertimage|insert)$/,wrap:/^(?:code)$/},E=/^(?:blockquote|pre|div)$/i,F=/(?:[pubia]|h[1-6]|blockquote|[uo]l|li)/i,G={whiteSpace:/(^\s+)|(\s+$)/g,mailTo:/^(?!mailto:|.+\/|.+#|.+\?)(.*@.*\..+)$/,http:/^(?!\w+?:\/\/|mailto:|\/|\.\/|\?|#)(.*)$/},H={url:/((https?|ftp):\/\/|www\.)[^\s<]{3,}/gi,prefix:/^(?:https?|ftp):\/\//i,notLink:/^(?:img|a|input|audio|video|source|code|pre|script|head|title|style)$/i,maxLength:100};A.is=function(a,b){return B.call(a).slice(8,-1)===b},A.forEach=function(a,b,c){if(a)if(null==c&&(c=A.is(a,"Array")),c)for(var d=0,e=a.length;e>d;d++)b(a[d],d,a);else for(var f in a)a.hasOwnProperty(f)&&b(a[f],f,a)},A.copy=function(a,b){return A.forEach(b,function(b,c){a[c]=A.is(b,"Object")?A.copy({},b):A.is(b,"Array")?A.copy([],b):b}),a},A.log=function(a,b){(y||b)&&console.log("%cPEN DEBUGGER: %c"+a,"font-family:arial,sans-serif;color:#1abf89;line-height:2em;","font-family:cursor,monospace;color:#333;")},A.delayExec=function(a){var b=null;return function(c){clearTimeout(b),b=setTimeout(function(){a()},c||1)}},A.merge=function(a){var c={"class":"pen",debug:!1,toolbar:null,stay:a.stay||!a.debug,stayMsg:"Are you going to leave here?",textarea:'<textarea name="content"></textarea>',list:["blockquote","h2","h3","p","code","insertorderedlist","insertunorderedlist","inserthorizontalrule","indent","outdent","bold","italic","underline","createlink","insertimage"],titles:{},cleanAttrs:["id","class","style","name"],cleanTags:["script"],linksInNewWindow:!1};return 1===a.nodeType?c.editor=a:a.match&&a.match(/^#[\S]+$/)?c.editor=b.getElementById(a.slice(1)):c=A.copy(c,a),c},x=function(a){if(!a)throw new Error("Can't find config");y=a.debug;var b=A.merge(a),c=b.editor;if(!c||1!==c.nodeType)throw new Error("Can't find editor");c.classList.add(b["class"]),c.setAttribute("contenteditable","true"),this.config=b,b.placeholder&&c.setAttribute("data-placeholder",b.placeholder),n(this),this.selection=z,this._events={change:[]},h(this),i(this),this._prevContent=this.getContent(),this.markdown&&this.markdown.init(this),this.config.stay&&this.stay(this.config),this.config.input&&this.addOnSubmitListener(this.config.input)},x.prototype.on=function(a,b){return j(this,this.config.editor,a,b),this},x.prototype.addOnSubmitListener=function(a){var b=a.form,c=this;b.addEventListener("submit",function(){a.value=c.config.saveAsMarkdown?c.toMd(c.config.editor.innerHTML):c.config.editor.innerHTML})},x.prototype.isEmpty=function(a){return a=a||this.config.editor,!(a.querySelector("img")||a.querySelector("blockquote")||a.querySelector("li")||o(a.textContent))},x.prototype.getContent=function(){return this.isEmpty()?"":o(this.config.editor.innerHTML)},x.prototype.setContent=function(a){return this.config.editor.innerHTML=a,this.cleanContent(),this},x.prototype.checkContentChange=function(){var a=this._prevContent,b=this.getContent();a!==b&&(this._prevContent=b,k(this,"change",b,a))},x.prototype.getRange=function(){var a=this.config.editor,c=z.rangeCount&&z.getRangeAt(0);return c||(c=b.createRange()),p(a,c.commonAncestorContainer)||(c.selectNodeContents(a),c.collapse(!1)),c},x.prototype.setRange=function(a){a=a||this._range,a||(a=this.getRange(),a.collapse(!1));try{z.removeAllRanges(),z.addRange(a)}catch(b){}return this},x.prototype.focus=function(a){return a||this.setRange(),this.config.editor.focus(),this},x.prototype.execCommand=function(a,b){a=a.toLowerCase(),this.setRange(),D.block.test(a)?e(this,a):D.inline.test(a)?c(this,a,b):D.source.test(a)?g(this,a,b):D.insert.test(a)?d(this,a,b):D.wrap.test(a)?f(this,a,b):A.log("can not find command function for name: "+a+(b?", value: "+b:""),!0),"indent"===a?this.checkContentChange():this.cleanContent({cleanAttrs:["style"]})},x.prototype.cleanContent=function(a){var b=this.config.editor;return a||(a=this.config),A.forEach(a.cleanAttrs,function(a){A.forEach(b.querySelectorAll("["+a+"]"),function(b){b.removeAttribute(a)},!0)},!0),A.forEach(a.cleanTags,function(a){A.forEach(b.querySelectorAll(a),function(a){a.parentNode.removeChild(a)},!0)},!0),n(this),this.checkContentChange(),this},x.prototype.autoLink=function(){return u(this.config.editor),this.getContent()},x.prototype.highlight=function(){var a=this._toolbar||this._menu,b=q(this);if(A.forEach(a.querySelectorAll(".active"),function(a){a.classList.remove("active")},!0),!b)return this;var c,d=r(this,b),e=this._inputBar;return e&&a===this._menu&&(e.style.display="none",e.value=""),c=function(b){if(b){var c=a.querySelector("[data-action="+b+"]");return c&&c.classList.add("active")}},A.forEach(d,function(a){var b=a.nodeName.toLowerCase();switch(b){case"a":e&&(e.value=a.getAttribute("href")),b="createlink";break;case"img":e&&(e.value=a.getAttribute("src")),b="insertimage";break;case"i":b="italic";break;case"u":b="underline";break;case"b":b="bold";break;case"pre":case"code":b="code";break;case"ul":b="insertunorderedlist";break;case"ol":b="insertorderedlist";break;case"li":b="indent"}c(b)},!0),this},x.prototype.menu=function(){if(!this._menu)return this;if(z.isCollapsed)return this._menu.style.display="none",this._inputActive=!1,this;if(this._toolbar&&(!this._inputBar||!this._inputActive))return this;var a=this._range.getBoundingClientRect(),b=10,c=a.top-b,d=a.left+a.width/2,e=this._menu,f={x:0,y:0},g=this._stylesheet;if(0===a.width&&0===a.height)return this;if(void 0===this._stylesheet){var h=document.createElement("style");document.head.appendChild(h),this._stylesheet=g=h.sheet}return e.style.display="block",f.x=d-e.clientWidth/2,f.y=c-e.clientHeight,g.cssRules.length>0&&g.deleteRule(0),f.x<0?(f.x=0,g.insertRule(".pen-menu:after {left: "+d+"px;}",0)):g.insertRule(".pen-menu:after {left: 50%; }",0),f.y<0?(e.classList.add("pen-menu-below"),f.y=a.top+a.height+b):e.classList.remove("pen-menu-below"),e.style.top=f.y+"px",e.style.left=f.x+"px",this},x.prototype.stay=function(a){var b=this;window.onbeforeunload||(window.onbeforeunload=function(){return b._isDestroyed?void 0:a.stayMsg})},x.prototype.destroy=function(a){var b=a?!1:!0,c=a?"setAttribute":"removeAttribute";if(a)h(this),i(this);else{m(this);try{z.removeAllRanges(),this._menu&&this._menu.parentNode.removeChild(this._menu)}catch(d){}}return this._isDestroyed=b,this.config.editor[c]("contenteditable",""),this},x.prototype.rebuild=function(){return this.destroy("it's a joke")},a.Pen=function(a){if(!a)return A.log("can't find config",!0);var b=A.merge(a),c=b.editor.getAttribute("class");return c=c?c.replace(/\bpen\b/g,"")+" pen-textarea "+b["class"]:"pen pen-textarea",b.editor.setAttribute("class",c),b.editor.innerHTML=b.textarea,b.editor};var I={a:[/<a\b[^>]*href=["']([^"]+|[^']+)\b[^>]*>(.*?)<\/a>/gi,"[$2]($1)"],img:[/<img\b[^>]*src=["']([^\"+|[^']+)[^>]*>/gi,"![]($1)"],b:[/<b\b[^>]*>(.*?)<\/b>/gi,"**$1**"],i:[/<i\b[^>]*>(.*?)<\/i>/gi,"***$1***"],h:[/<h([1-6])\b[^>]*>(.*?)<\/h\1>/gi,function(a,b,c){return"\n"+"######".slice(0,b)+" "+c+"\n"}],li:[/<(li)\b[^>]*>(.*?)<\/\1>/gi,"* $2\n"],blockquote:[/<(blockquote)\b[^>]*>(.*?)<\/\1>/gi,"\n> $2\n"],pre:[/<pre\b[^>]*>(.*?)<\/pre>/gi,"\n```\n$1\n```\n"],code:[/<code\b[^>]*>(.*?)<\/code>/gi,"\n`\n$1\n`\n"],p:[/<p\b[^>]*>(.*?)<\/p>/gi,"\n$1\n"],hr:[/<hr\b[^>]*>/gi,"\n---\n"]};x.prototype.toMd=function(){var a=this.getContent().replace(/\n+/g,"").replace(/<([uo])l\b[^>]*>(.*?)<\/\1l>/gi,"$2");for(var b in I)I.hasOwnProperty(b)&&(a=a.replace.apply(a,I[b]));return a.replace(/\*{5}/g,"**")},b.getSelection&&(z=b.getSelection(),a.Pen=x)}(window,document);